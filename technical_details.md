

---

# General View #
<b>GISOO</b> stands for <b>G</b>raphical <b>I</b>ntegration of <b>S</b>imulink snd C<b>OO</b>ja and as the name represent each simulation in GISOO should be consist of the combination of two simulations, one in Cooja and another one in Simulink which are synchronous together with the possibility of data communication.
In fact all the wireless system (which also can contain the controller) will be simulated in the Cooja and the plant will be simulated in Simulink, and whenever simulated system in Cooja needs to measure some variables in plant or actuate some actuators there, the sensor or actuator mote in Cooja will send the request for sensor value or send the actuation data to their mirror sensor or actuator in the Simulink model which are in contact with the plant model and can receive the requested sensor data or apply the actuation value. The following picture show the genera view of the the GISOO which can show the mirror motes in Cooja and Simulink and the location of the motes in the relation with the plant. (The following picture shows the situation that the controller located in one of the motes, but it is also possible to locate the controller in a PC)

<p align='center'>
<img src='https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/DesignedModel.png' height='682px' width='637px'>
<p>

In order to have the mentioned system worked, we needs to be able to have a proper data communication and also both systems should work synchronously. So the main facts to create GISOO are providing a proper data communication system and accurate synchronization. The following sections will explain the details of designed and implemented parts to achieve these goals. Since the data communication is also used for the synchronization, firstly we need to understand the data communication details.<br>
<br>
<h1>Data Communication</h1>
In the first step to prepare the simulation in GISOO we need to add all the wireless motes to the Cooja environment and then in the next step we need to activate the provided GISOO-plug-in in Cooja (GISOO-Simulink plugin) to handle the data communication and synchronization for GISOO. This plug-in will create a UDP port which the port number is equal to "18000+Mote-id" and it will listen on this port to receive the data from Simulink which are related to this mote. It means that each mote in Cooja will have its own specific UDP port to receive data.<br>
<br>
<p align='center'>
<img src='https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/Cooja_Mote_PortNumber.png'>
<p>

On the other side Simulink model has different situation and all the Model will receive data from one predefined UDP port which by default is port number 55555. This means that all the data which should be received by Simulink or even a specific part of Simulink model, should be sent to this port.<br>
<br>
<p align='center'>
<img src='https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/SimulinkReceivePortnumber.png' height='682px' width='737px'>
<p>

<h2>Simulation procedure</h2>

In GISOO, Cooja is responsible for controlling the simulation procedure. It means that Cooja will start simulating the wireless system until the moment that one of the motes in Cooja needs to send or receives some data to/from plant model. This can happen in four situations:<br>
<br>
<ul><li>A sensor mote needs to sense some sensor data.<br>
</li><li>An actuator mote needs to apply some actuation values on the plant.<br>
</li><li>A mote needs to send some serial data.<br>
</li><li>A mote needs to receive some serial data.</li></ul>

In any of these situations a mote in Cooja will send a message to the Simulink model to inform Simulink that at which moment which kind of action in which mote is required. To achieve this aim an especial message structure has been designed. This message contains four different parts:<br>
<br>
<ul><li>Simulation time<br>
</li><li>Mote-Pin-ID<br>
</li><li>Actuation value (uValue)<br>
</li><li>Serial data</li></ul>

<b>Simulation time (4 bytes):</b> In the message structure the first four bytes considered for carrying the Simulation time (in millisecond). In fact Cooja will run until the moment that a mote needs an especial communication with Simulink, then it will generate a message and add the time of simulation in Cooja to the beginning of the message. On the other side, Simulink will pause the simulation until it receive a message from Cooja. Then in the first step it will extract the Cooja time from the beginning the the message and will run the Simulink simulation to reach that specific moment. This procedure will be explained more in the synchronization explanation in this page.<br>
<br>
<b>Mote-Pin-ID (4 bytes):</b> Whenever a message generated by a mote in Cooja, Simulink as a receiver should be aware that this message came from which mote and should affect which part (pin) of that mote. For instance when a mote with id=4 needs to read data from its ADC1, in the message which will be send to Simulink both of the "mote-id" and "ADC1 (which we called it pin number)" should be clear. For this aim we generate a number by name of mote-pin-id which has been created by this method:<br>
<br>
mote-pin-id = Mote-id*100 + pin number<br>
<br>
and considered pin-ids are:<br>
<br>
<ul><li>ADC0 - ADC12 = 0 - 12<br>
</li><li>DAC0 - DAC1  = 16 - 17<br>
</li><li>Serial data to be sent to Simulink = 18<br>
</li><li>Serial data to be received from Simulink = 19</li></ul>

<b>Actuation value (uValue - 4 bytes):</b> Although only some of the messages are used to apply an actuation value to the plant, because of needs of fix message format in GISOO, these four bytes will be inside of all the messages, but these bytes will receive value and also their value will be used only whenever a mote in Cooja wants to apply an actuation value to the plant.<br>
<br>
<b>Serial data(16 bytes):</b> for the same reason as it mentioned for actuation value, all the messages will carry 16 bytes of serial message, but they will only be used whenever some serial data is needed to be transmitted from Cooja to Simulink or in vice versa.<br>
<br>
The following picture shows a schema of the designed message structure for GISOO.<br>
<br>
<br>
<p align='center'>
<img src='https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/MSGStructure.png'>
<p>

<h1>Synchronization</h1>
Another important factor for GISOO, is its accurate synchronization system. In GISOO as it has been mentioned, the Cooja will control the simulation time and for this reason Cooja will run its simulation until the moment that a mote in Cooja needs to send or receive some data to/from Simulink. In this moment the GISOO plugin in Cooja for that mote will create a message and send it to Simulink which contain the accurate time of simulation in Cooja (in millisecond). As soon as the plug-in send the message, it will pause the simulation in that moment to receive a reply from Simulink. This reply can be a sensor value or serial data or an acknowledgement, but receiving a data is important otherwise the Cooja will not continue its Simulation.<br>
This pause in Cooja always create by executing a "receive" command after sending a data. Since the "receive"command is a blocking function the simulation will stay on that moment until it could read some data and pass that state. The following code shows the part of the code which send a request for an ADC value and make a pause in simulation until the ADC for that moment be receives.<br>
<br>
<pre><code>protected int adcRequestSender(byte[] message, DatagramSocket dgSocket) {<br>
<br>
        try {<br>
            InetAddress IPAddress = InetAddress.getByName("localhost");<br>
            DatagramPacket dgPacket = new DatagramPacket(message, message.length, IPAddress, SIMULINK_PORT);<br>
            dgSocket.send(dgPacket);<br>
        } catch (IOException ex) {<br>
            System.out.println("Error in sending dgPacket in adcRequestSender!!");<br>
        }<br>
        byte[] receivedValue = new byte[4];<br>
        DatagramPacket receivedPacket = new DatagramPacket(receivedValue, receivedValue.length);<br>
        try {<br>
<br>
            dgSocket.receive(receivedPacket); //This line will make a pause in Cooja's simulation until the sensor data be received.<br>
<br>
        } catch (IOException ex) {<br>
            System.out.println("Error in receive UDP data adcRequestSender!!");<br>
            System.out.println(ex.getMessage());<br>
        }<br>
        byte[] data = receivedPacket.getData();<br>
        return (bytes2Int1(data));<br>
    }<br>
</code></pre>

On the other side the Simulink is in the pause mode from the beginning and it will wait until it receives a message from Cooja. As soon as it receive a message, it will extract the time of simulation in Cooja and then it will continue the Simulation until it reach the Simulation time in Cooja and then send back the requested data or apply the actuation data in that moment. The time duration between two messages is the duration that Simulink can run the simulation independent of the simulation in Cooja and since normally Simulink is much faster than Cooja, the Simulink can catch the simulation time in Cooja in very short period of time.(It will depend on the complexity of the plant model in Simulink).<br>
The following picture shows the combination of Synchronization and message communication in GISOO.<br>
<br>
<p align='center'>
<img src='https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/MSGTimeLine.png' height='782px'>
<p>

The most important point which has been achieved in the result of the designed data communication system is that Since, both of the Simulink and Cooja will be completely frozen during the communication procedure, the delay of communication between Simulink and Cooja <b>will not</b> affect the result of simulation.<br>
<br>
<h1>GISOO Simulink Library</h1>
GISOO uses its specific Simulink library and this part will explain about the details of designed system for achieving the proper functionality in simulation.<br>
<br>
<h2>GISOO Simulation Environment</h2>

GISOO-Simulink-library contains a main block to handle both of the synchronization and the data communication (receiving the data in Simulink) which known as "GISOO-Simulation Environment". This block Simulate the Cooja environment and its motes inside the Simulink, and also if we needed to implement the controller model inside the Simulink, it should be added inside this block. The plant model should be located out of this block. More explanation and examples can be find in <a href='https://code.google.com/p/kth-gisoo/wiki/Samples'>here</a> and <a href='https://code.google.com/p/kth-gisoo/wiki/Samples#Double-tank_system_with_the_controller_in_PC'>here</a>.<br>
"GISOO-Simulation Environment" block is a do-while block which can pause the simulation of the plant model "while" it has not receive a new time from Cooja and "do" continue the simulation of the plant model when it receive a new simulation time from Cooja.<br>
<br>
This block also should be able to continuously receive the message from Cooja and for this aim we add additional parts which can handle the receiving the data.<br>
The following picture shows the "GISOO_Simulation_Environment" block.<br>
<p align='center'>
<img src='https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/GISOO_Simulation_Environment.png'>
<p>

Inside the "GISOO_Simulation_Environment" has been shown in the following picture. As it has been shown, it contains a GISOO-Simulink plugin block which is responsible for receiving the data from Cooja and also it will synchronize the Simulink with Cooja. The other block is "SynchronizerLoop" which just control the do while loop in Simulink.<br>
<br>
<p align='center'>
<img src='https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/CoojaConnector.png'>
<p>

The next picture shows the entire of the "GISOO-Simulink plugin". As it has been marked in the picture This block will receive messages from Cooja and extract the Simulation-Time, mote-pin-id, uValue and, Serial data and also compare the Simulation time in Simulink with the Simulation time in Cooja and if Simulink is behind, it will continue the simulation to reach the proper time. The three blocks in the top right side of the picture shows the maximum number of the iteration that the while loop will do. This number will config the maximum time that Simulink can wait to receive a message from Cooja and if Simulink does not receive any message in this duration will consider it as a result of a problem in communication with Cooja, and to avoid the infinitive simulation loop, the stop block will stop the Simulink Simulation which will show a message on the screen. (If in the scenario you need bigger time intervals to receive messages from Cooja, you can increase the default value of this block, which is 300000 in the following figure.)<br>
<p align='center'>
<img src='https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/Inside_GISOO_Simulation_Env.png'>
<p>

The Following picture shows the message created by Stop block when it could not receive a message from Cooja before it reach the maximum number of its iteration.<br>
<br>
<p align='center'>
<img src='https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/SimulationStop.png'>
<p>

<blockquote><h2>Sky-Mote</h2></blockquote>

The SkyMote bloke has been designed to mimic the actions of a real mote such as reading ADC, writing on DAC, and sending and receiving the radio data in the Simulink.<br>
The following figure shows the structure of the SkyMote block. This block will receive four data from the "CoojaConnector" block in the "GISOO-Simulation-Environment" which are:<br>
<br>
<ul><li>Time-Is-Correct: is a boolean value which shows that if the Simulink time is equal with the Cooja time which has been received from the message or not.</li></ul>

<ul><li>Interface-Identifier: is the value of the mote-pin-id which has been explained in <a href='https://code.google.com/p/kth-gisoo/wiki/technical_details#Data_Communication'>Data Communication</a></li></ul>

<ul><li>uValue: is the actuation value for DACs, it also has been explained in <a href='https://code.google.com/p/kth-gisoo/wiki/technical_details#Data_Communication'>Data Communication</a></li></ul>

<ul><li>Input Serial-Data: is the serial data that has been received from Cooja.</li></ul>


More over to above values, the SkyMote can receive the output serial data from the mote input.<br>
<br>
In the mote structure picture the first colorful column from left (light orange) are the constant blocks which represent the pin-id of the motes. The values of pin-ids has been explained in <a href='https://code.google.com/p/kth-gisoo/wiki/technical_details#Data_Communication'>Data Communication</a>. These values will be used to fined the received data belongs to which pin.<br>
<br>
The other three colorful columns are three filters which finally can make the correct action in the mote based on the received data.<br>
<br>
The firs filter column from left which are shown in light green, will discover if the received pin-id is the same as the constant number that has been compared or not. For each received message in Simulink one and only one of these blocks will return true and the rest will be false.<br>
<br>
In the second comparison, first the value of mote-id will be extracted from mote-pin-id value and then this value will be compared with id of the mote in Simulink. If the result of this comparison was true it means that the received message belonged to this mote otherwise it belongs to some other motes. In the final step, we will "AND" (logical and)the boolean result of this comparison with the result of previous filter and this AND can be considered as the second layer of filtering which has been shown in the orange column.<br>
<br>
Finally the last filter will check if the time of simulation in Simulink is exactly the same as the time of the simulation in Cooja which we had received in the received message or not. This step will also be achieved by performing a logical AND between the results of the second filter and the received boolean value from GISOO-Simulink plugin(IsTimeCorrect) and creates the third and the last filter that has been shown in yellow in the picture. Only the data which could pass all these layers of the filters can activate the proper action block which will perform the ADC reading or applying the DAC value or receiving the serial data or sending the serial data.<br>
Since we always used the ADC0 and ADC1 we just use them and we terminate the rest of the ADCs in our block model. But they can be used in the case of need. (ADC5 should be active but not used because of some unstudied problem in Cooja.)<br>
<p align='center'>
<img src='https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/Mote.png'>
<p>

The only action which needs extra procedure is the sending out of the serial-data. Since when we want to send the data to the serial port of a mote, we should create a complete serial message including its header, payload (serial data) and footer, in this model also we have pass the serial data from a specific designed block to create a serial message.(The block has been shown in light blue in the previous figure) The structure of serial message can be found in <a href='http://tinyos.cvs.sourceforge.net/viewvc/tinyos/tinyos-2.x/doc/html/tep113.html'>TEP 113</a>. But it should be mentioned that the two bytes of CRC should be created over P to end of the payload. (Not over S until end of the payload  as it has mentioned at the end of the TEP-113)